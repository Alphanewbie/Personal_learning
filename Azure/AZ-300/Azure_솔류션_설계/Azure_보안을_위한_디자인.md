# Azure에서 멋진 솔루션 설계

## Azure의 보안을 위한 디자인

### 심층 방어

#### 제로 트러스트

신뢰를 가정하고 않고 지속적으로 신뢰를 검즘해야 한다.

사용자, 디바이스 및 데이터가 모두 조직의 방화벽 내에 있는 경우 신뢰할 수 있는 것으로 간주한다. 해커가 악의적으로 엔드포인트 디바이스를 손상시킨 이후 이렇게 가정된 신뢰는 쉬운 횡적 이동을 허용한다.

대부분의 사용자가 인터넷에서 애플리케이션 및 데이터에 액세스하고, 많은 회사에서 사용자가 BYOD(Bring-Your-Own-Devices)를 허용할 때 트랜잭션의 구성요소(사용자, 네트워크 및 디바이스) 대부분은 더 이상 조직의 제어를 받지 않습니다. 제로 트러스트 모델은 검증 가능한 사용자 및 디바이스의 신뢰 클레임을 사용하여 조직 리소스에 대한 액세스 권한을 부여합니다. 이제 위치가 조직 경계 내에 있다는 사실만으로 신뢰를 가정하지 않습니다.

이 모델로 인해 보안 연구원, 엔지니어 및 아키텍트는 **심층방어**라는 계층형 리소스 보호 보안 전락에 접근 방식을 다시 생각해 보게 되었습니다.

##### 심층방어

보안에 있어서 한가지의 방어 수준이 적절하지 않을 수도 있다.

데이터의 중요성에 따라 여러개 사용 사능

예를 들어 사용자가 WAF(웹 응용 프로그램 방화벽)을 사용하고 있고, 공격자가 이를 우회해서 공격하는 것을 막는것.

여기서 보낼 수 있는 악의적인 요청을 막으려면 사용자의 웹사이트는 입력 유효성 검사, 출력 인코딩 및 매개변수가 있는 쿼리 등 자체 방어를 갖춰야 한다.

이 개념의 또다른 구현이 바로 다단계 인증, 세가지 요소로 구성된다.

1. Knowledge factors
2. Ownership factors
3. Inherence factors

시스템에 인증하기 위해서는 두가지 요소가 필요 -> 공격자가 공격하기 2배로 어려워진다.

여기에는 

키 자격 증명 모음, 

인증서, 

연결 문자열, 

비밀 및 암호 넣기 

일반적으로 악성 IP 범위의 트래픽을 블랙홀링 차단하여 서비스 거부 공격을 감지하고 방어하는 추가된 네트워크 방어 계층인 DDOS보호 활성화, 

위험이 감지될 경우 즉시 정보를 받는 로깅, 감사 및 위협 보호 활성화, 

공격 표면을 줄기이 귀해 단기만 열어주는 요청한 경우를 제외하고는 모든 포트를 닫는 JIT(Just in time) 액세스 컨트롤 사용

응용 프로그램 코드에 대한 보안 테스팅 및 보안 코드 검토 수행, 

보안 디자인 및 보안 코딩에 관한 모범 사례를 따르고 항상 디자인에 대한 다른 사용자의 의견 묻기



#### 보안에 대한 계층화된 접근 방법

심층 방어는 정보에 무단으로 액세스 하려는 공격의 진행 속도를 늦추는 일련의 매커니즘을 사용하는 전략. 각 레이어가 보호를 제공하므로 한 레이어에서 침해 사고가 발생하더라도 후속 레이어가 이미 작동하기 때문에 추가 노출을 방지한다. 심층 방어의 목적은 액세스 권한이 없는 개인으로부터 정보를 보호하고 도난을 방지하는 것.

##### 보안의 3요소

- **기밀성** -  최소 권한의 원칙. 명시적으로 액세스 권한이 부여된 개인만 정보에 액세스 가능하도록 제한. 이 정보에는 사용자 암호, 원격 액세스 인증서 및 이메일 콘텐츠에 대한 보호 포함
- **무결성** - 미사용 및 전송 중인 정보의 무단 변경 방지, 데이터 전송에 사용되는 일반적인 방법은 발신자가 반향향 해시 알고리즘을 사용하여 고유한 데이터 지문을 만드는 것. 해시는 데이터와 함께 수신자에게 전송된다. 수신자는 데이터의 해시를 다시 계산해서 원본과 비교하여 데이터가 전송 도중에 손실 또는 수정 되지 않았는지 확인한다.
- **가용성** - 인증된 사용자가 서비스를 이용할 수 있어야한다. 서비스 거부 공격으로 인해 사용자에게 가용성 손실이 자주 발생한다. 또한 자연재해를 고려하여 단일 실패 지점을 방지하고 여러 애플리케이셩 인스턴스를 지리적으로 분산된 위치에 배포하도록 시스템을 설계해야 한다.

#### 보안 계층

데이터 보안을 시작화 했을 때의 레이어

![센터에 있는 데이터를 사용한 심층 방어를 보여주는 일러스트레이션 데이터와 관련된 보안은 애플리케이션, 컴퓨팅, 네트워크, 경계, ID와 액세스 및 물리적 보안을 포함합니다.](https://docs.microsoft.com/ko-kr/learn/modules/design-for-security-in-azure/media/defense_in_depth_layers_small.png)

##### 데이터

공격자의 목표가 데이터

- 데이터베이스에 저장된 데이터
- 가상 머신 내부의 디스크에 저장된 데이터
- Office 365와 같은 SaaS애플리케이션에 저장된 데이터
- 클라우드 스토리지에 저장된 데이터

데이터를 저장하고 액세스를 제어하는 사용자는 데이터를 적절하게 보호할 책임이 있다.

##### 애플리케이션

- 안전하고 취약점이 없도록 애플리케이션 보호
- 중요한 애플리케이션 비밀을 안전한 스토리지 매체에 저장
- 모든 애플리케이션 개발 시 보안을 요구 사항으로 지정

애플리케이션 개발 수명 주기에 보안을 통합하면 코드에서 발생하는 취약점을 줄일 수 있다. 모든 개발 팀이 기본적으로 애플리케이션을 안전하게 만들도록 합니다. 보안 요구사항을 협상하지 않도록 한다.

##### 컴퓨팅

- 가상머신 액세스 보안
- 엔드 포인트 보호를 구현하고 지속적으로 시스템 패치 및 최신 상태 유지

멀웨어, 패치가 적용되지 않는 시스템, 적절하게 보호되지 않는 시스템 때문에 환경이 공격에 노출된다. 이 레이어의 핵심을 컴퓨팅 리소스를 안전하게 보호하고 보안 문제를 최소화하는 적절한 제어가 마련

##### 네트워킹

- 엑세스 구분 및 제어를 통해 리소스 간의 통신 제한

- 기본적으로 거부

- 언바운드 인터넷 엑세스를 금지하고 필요한 경우 아웃바운드를 제한

- 온-프레미스 네트워크에 대한 보안 연결을 구현

  [^온-프레미스]: 원격 환경이 아닌 자체적으로 보유한 전살실 서버에 직접 설치해 운영하는 방식

이 계층의 핵심은 필요한 리소스에만 액세스 할 수 있도록 모든 리소스에서 네트워크 연결을 제한하는 것입니다. 리소스를 분할하고 네트워크 수준 제어를 사용하여 필요한 경우에만 통신을 제한합니다. 이 통신을 제한하여 네트워크 전체에서 횡적 이동의 위험을 줄인다

##### 경계

- DDOS 보호 기능을 사용하여 최종 사용자에게 서비스 거부가 발생하기 전에 대규모 공격을 필터링
- 경계 방화벽을 사용하여 네트워크에 대한 악의적인 공격을 파악하고 그에 대해 경고

네트워크 경계에서, 리소스에 대한 네트워크 기반 공격을 방어한다. 네트워크 보안을 위자하려면 이러한 공격을 파악하여 영향을 제거하고 공격에 대해 경고하는 것이 중요.

##### ID 및 액세스

- 인프라에 대한 액세스 제어, 변경 제어
- Single Sign-On 및 다단계 인증 사용
- 이벤트 및 변경 내용 감사

ID 및 액세스 레이어는 ID를 안전하게 보호하고, 필요한 때에만 액세스 권한을 부여하고 변경 내용을 기록한다.

##### 물리적 보안

- 물리적 빌드 보안 및 데이터 센터 내의 컴퓨팅 하드웨어에 대한 액세스 제어가 첫 번째 방어선 입니다.

물리적 보안을 사용하는 목적은 자산 액세스에 대한 물리적 보호수단을 제공하는 것. 이렇게 하면 다른 레이어가 무시되지 않는지 및 손실 또는 도난이 적절하게 처리되는지 확인할 수 있다.

각 레이어는 CIA 중 하나를 구현할 수 있다.

| #    | 원           | 예                                           | 원칙   |
| :--- | :----------- | :------------------------------------------- | :----- |
| 1    | 데이터       | Azure Blob 스토리지의 미사용 데이터 암호화   | 무결성 |
| 2    | 애플리케이션 | SSL/TLS 암호화 세션                          | 무결성 |
| 3    | 컴퓨팅       | 정기적으로 OS 및 계층화 소프트웨어 패치 적용 | 가용성 |
| 4    | 네트워크     | 네트워크 보안 규칙                           | 기밀성 |
| 5    | 경계         | DDoS 보호                                    | 가용성 |
| 6    | ID 및 액세스 | Azure Active Directory 사용자 인증           | 무결성 |
| 7    | 물리적 보안  | Azure 데이터 센터 생체 인식 액세스 제어      | 기밀성 |

#### 문제

1. *심층 방어*는 사용자 정보에 액세스 권한을 얻으려는 공격으로부터 보호하기 위한 전략인가요?

   *심층 방어*는 권한이 없는 액세스로부터 보호를 제공하는 계층화된 시스템입니다. 한 계층을 위반하는 경우 추가로 노출되지 않도록 하기 위해 다른 계층이 마련됩니다.



### ID 관리

#### 보안 계층으로써의 ID

디지털 ID는 오늘날 비즈니스 및 소셜 상호 작용 온-프레미스와 온라인에서 필수 요소

과거에는 ID 및 액세스 서비스가 회사 내부 네트워크에서만 작동하도록  Kerberos 및 LDAP 같은 프로토콜을 사용하게 제한 되었다.

최근에는 모바일 디바이스를 이용해 디지털 서비스와 상호작용.

고객과 직원 모두가 언제, 어디서나 서비스에 액세스 할 수 있기를 원하며 이로 인해 여러 별도의 디바이스 및 운영체제에서 인터넷 규모로 작동할 수 있는 ID프로토콜이 개발되었습니다.

아키텍쳐의 ID관련 기능을 평가할 때 다음 기능을 애플리케이션으로 가져오는 방법

- 애플리케이션 사용자에게 Single Sign-On제공
- 최소한의 노력으로 최신 인증을 사용하도록 레거시 애플리케이션 개선
- 회사 네트워크 외부에서 이루어 지는 모든 로그인에 MFA(다단계인증) 적용
- 안전하게 등록하고 계쩡 데이터를 관리할 수 있는 애플리케이션 개발

#### Single Sign-On

사용자가 관리할 ID가 많을 수록 자격 증명 관련 보안 사건이 발생할 위험이 높다. 더 많은 ID는 더 많은 암호를 기억하고 변경해야 한다는 뜻. 암호 정책은 애플리케이션에 따라 다를 수 있으며, 복잡한 요구사항이 늘어나면 사용자가 암호를 기억하기 더 어려워진다.

반대편에는 모든 ID에 요구되는 관리 업무가 있다. 계정 잠금 및 암호 재설정 요청을 처리하는 기술 지원팀의 부담이 가중됩니다. 사용자가 조직을 떠날 때 해당 사용자의 모든 ID를 추적하여 비활성화 하는 것이 어려울 수 있습니다. ID를 간과하면 제거되었어야 하는 ID를 통해 액세스 할 수 있는 문제가 발생 할 수 있습니다.

Single Sign-On을 사용하면 사용자는 ID하나와 암호 하나만 기억하면 됩니다. 애플리케이션에 대한 액세스 권한이 사용자와 연결된 ID에 부여되므로 보안 모델이 간소화 됩니다. 액세스 수정이 단일 ID에 연결되어 있으므로 사용자 역활이 변경 되거나 사용자가 조직을 떠날때 계정을 변경하거나 비활성화 하는 과정이 대폭 축소됩니다. 계정에 Single Sign-On을 사용하면 간편하게 관리및 환경의 보안 기능이 향상됩니다.

##### Azure Active Directory를 사용한 SSO

Azure AD(Active Diretory)는 클라우드 기반 ID 서비스입니다. 기존 온-프레미스 Active Directory 와 동기화 하거나 독립 실행형으로 사용할 수 있도록 지원이 기본 제공됩니다. 즉, 온-프레미스든, 클라우드든, 모바일이든 관계없이 모든 애플리케이션이 동일한 자격 증명을 공유할 수 있습니다. 관리자와 개발자는 중앙 집권식 규칙과 Azure AD에서 구상한 정책을 사용하여 데이터 및 애플리케이션에 대한 액세스를 제어할 수 있습니다.

또한 SSO에 Azure AD를 활용하면 여러 데이터 원본을 지능형 보안 그래프로 결합할 수 있습니다. 이 보안 그래프로 결합할 수 있습니다. 이 보안 그래프를 통해 온-프레미스 AD에서 동기화된 계정을 포함하여 Azure AD의 모든 계정에 위협 분석 및 실시간 ID보호 기능을 제공할 수 있습니다. 중앙 집중식 ID공급자를 사용하면 ID인프라의 보안제어, 보고, 경고 및 관리를 중앙 집중화할 수 있습니다.

##### AD Connect를 사용하여 디렉토리 동기화

Azure AD Connect는 온-프레미스 디렉터리와 Azure Active Directory를 통합합니다. Azure AD Connect는 최신 기능을 제공하며 DirSync 및 Azure AD Sync같은 이전 버전의 ID통합 도구를 대체합니다.

동기화 및 로그인에 대해 간편한 배포 환경을 제공하는 단일 도구입니다.

![Azure AD 연결을 보여 주는 일러스트레이션은 Azure Active directory 및 Azure 클라우드의 앱과 온-프레미스 디렉터리를 동기화하는 데 사용합니다. 이를 통해 사용자는 Azure 클라우드 내의 모든 애플리케이션에 대한 공용 기호를 가질 수 있습니다.](https://docs.microsoft.com/ko-kr/learn/modules/design-for-security-in-azure/media/aadconnectxprs_960.png)

AD Connect를 이용한 시스템 개선

- AD Connect 를 사용하여 온-프레미스 Active Directory에 저장된 그룹, 사용자 계정 및 암호 해시를 AD Connect와 동기화
  - 통과 인증을 사용할 수 없는 경우 백업으로 사용 가능
- 온-프레미스 Windows Server에 설치된 온-프레미스 인증 에이전트를 사용하여 통과 인증 구성
- AD Connect의 원활한 Single Sign-On기능을 사용하여 온-프레미스 도메인에 조인된 PC사용자를 자동으로 로그인
  - 여러 인증 요청을 억제하여 사용자 마찰 감소

#### 인증 및 액세스

##### 다단계 인증

MFA(다단계 인증)는 전체 인증에 2개 이상의 요소를 요구하여 ID에 추가 보안을 제공합니다. 이러한 요소는 세가지 범주로 분류됩니다.

- Knowledge factors
  - 암호이거나 보안 질문에 대한 대답. 사용자가 소유하고 있는 것은  일 수도 있습니다. 사용자의 신원 정보는 
- Ownership factors
  - 알림을 받는 모바일 앱 또는 토큰 생성 디바이스
- Inherence factors
  - 여러 모바일 디바이스에서 사용되는 지문 또는 얼굴 검사처럼 일반적으로 생체 인식 속성의 일종입니다.

회사 네트워크 외부에서 이루어지는 모든 로그인에 MFA 적용. 사용자의 암호를 알고 있는 공격자가 완벽하게 인증하려면 사용자의 전화기를 소유하고 있거나 사용자의 얼굴이 필요합니다. 단일 요소의 확인을 거친 인증 만으로는 부족하며 공격자는 이러한 자격 증명을 사용하여 인증 할 수 없습니다.



##### 조건부 액세스 정책

MFA와 함께, 추가적으로 보안 계층을 더하려면 액세스를 부여하기 전에 추가 요구 사항을 충족하도록 하면 됩니다. 의심스러운 IP주소의 로그인을 차단하거나 멀웨어 보호 기능이 없는 디바이스의 액세스를 거부하면 위험한 로그인의 액세스를 제한할 수 있습니다.

Azure Active Directory는 그룹, 위치 디바이스 상태 기반의 액세스 정책을 지원하는 CAP 기능을 제공합니다. 위치 기능을 사용하면 회사 네트워크에 속하지 않은 IP주소를 구분하고 이와같은 모든 위치에서는 다단계 인증을 사용하도록 요구하여 보안 정책을 충족할 수 있습니다.

![조건부 액세스 정책 및 다단계 인증의 샘플 구현을 보여 주는 일러스트레이션입니다. 온-프레미스 및 클라우드 애플리케이션 액세스에 대한 사용자 요청은 먼저 조건 목록에 대해 확인합니다. 요청은 액세스가 허용되거나, 다단계 인증을 통과하도록 강제되거나, 충족되는 조건에 따라 차단됩니다.](https://docs.microsoft.com/ko-kr/learn/modules/design-for-security-in-azure/media/conditional-access.png)

#### 레거시 애플리케이션 보호

온-프레미스에 호스트되는 관리 애플리케이션에 대한 보안 원격 액세스를 요구합니다. 사용자들은 방화벽으로 보호되는 조인 머신에서 WIZ(Windows 통합 인증)을 사용하여 애플리케이션에 인증합니다. 애플리케이션에 최신 인증 매커니즘을 통합하는 프로젝트가 계획되었지만, 원격 액세스 기능을 최대한 빨리 사용하게 해달라는 비즈니스 압력을 심하게 받고 있습니다. Azure 애플리케이션 프록시는 코드 변경 없이 원격으로 빠르고 쉽고 안전하게 애플리케이션에 액세스 할 수 있습니다.

##### 특징

- 단순 
  - 애플리케이션 프록시를 사용하도록 애플리케이션을 업데이트 할 필요가 없다.
  - 사용자에게 일관된 인증 환경이 제공됩니다. MyApp포털을 사용하여 클라우드 및 앱 온-프레미스의 SaaS앱에 Single Sign-On을 가져올 수 있습니다.
- 안전
  - Azure AD 애플리케이션 프록시를 사용하여 앱을 게시하면 Azure의 다양한 권한 부여 제어 및 보안 분석을 이용할 수 있습니다. 클라우드 규모 보안 및 조건부 액세스 및 2단계 인증 같은 Azure보안 기능이 제공됩니다.
  - 사용자에게 원격 액세스를 제공하기 위해 방화벽을 통해 어떤 인바운드 연결도 열 필요가 없습니다.
- 비용 효율적
  - 애플리케이션 프록시는 클라우드에서 작업하므로 시간과 비용을 절약할 수 있습니다. 온-프레미스 솔루션을 사용하려면 일반적으로 DMZ, 애저 서버 또는 기타 복잡한 인프라를 설정하고 유지 관리해야 합니다.

Azure AD애플리케이션 프록시는 두개의 구성 요소로 구성됩니다. 하나는 회사 네트워크 내부의 Windows서버에 위치하는 커넥터 에이전트이고, 다른 하나는 외부 엔트 포인트입니다. 사용자는 엔트 포인트를 탐색할 때 Azure AD로 인증하며 커넥터 에이전트를 통해 온-프레미즈 애플리케이션으로 라우팅 됩니다.

#### 소비자 ID사용

Azure AD B2C는 Azure Active Directory의 견고한 기반을 바탕으로 제작된 ID관리 서비스로, 애플리케이션을 사용할 때 고객이 자신의 프로필을 등록, 로그인 및 관리하는 방법을 사용자 지정하고 제어할 수 있습니다. Azure AD B2C는 소셜 ID 로그인 환경을 제공하는 동시에 고객 ID 프로필 정보를 보호합니다. Azure AD B2C 디렉터리는 표준 Azure AD 디렉터리와 다르며 Azure Portal에서 만들 수 있습니다.



### 인프라 보호

#### 인프라의 중요성

